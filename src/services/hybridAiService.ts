// Hybrid AI Service - Multi-provider AI service
import { supabase } from '@/lib/unifiedSupabaseClient';
import { config, useMockAi } from '@/config/environment';
import { createAIProvider, AIProviderService } from './aiProviderService';
import { createChatDataModificationService, ChatDataModificationService } from './chatDataModificationService';
import { aiConfigManager } from '@/config/aiConfig';
import { findProvincesInText, getProvinceByAlias } from '@/data/provinces';
import { ChatMessage as DBChatMessage } from '@/types/database';

// Helper function to generate valid UUID
function generateUUID(): string {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0;
    const v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

// Helper function to validate UUID
function isValidUUID(uuid: string): boolean {
  const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
  return uuidRegex.test(uuid);
}

// Helper function to get guest ID
function getGuestId(): string {
  let guestId = localStorage.getItem('guest_id');
  if (!guestId) {
    guestId = `guest_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    localStorage.setItem('guest_id', guestId);
  }
  return guestId;
}

export interface ChatMessage {
  id?: string;
  role: 'user' | 'assistant' | 'system';
  content: string;
  content_en?: string;
  language?: string;
  created_at?: string;
  trip_id?: string;
  user_id?: string;
}

export interface AIResponse {
  success: boolean;
  response: string;
  suggestLogin?: boolean;
  loginReason?: string;
  error?: string;
}

// Mock responses for development
const mockResponses = {
  '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ': '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ AI Travel Assistant ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì ‡∏ö‡∏≠‡∏Å‡∏ú‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏õ‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô!',
  '‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û': '‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÄ‡∏•‡∏¢! ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏°‡∏≤‡∏Å‡∏°‡∏≤‡∏¢ ‡∏ú‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏õ:\n\nüìç ‡∏ß‡∏±‡∏î‡πÇ‡∏û‡∏ò‡∏¥‡πå - ‡∏ß‡∏±‡∏î‡πÇ‡∏ö‡∏£‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏û‡∏£‡∏∞‡∏û‡∏∏‡∏ó‡∏ò‡πÑ‡∏™‡∏¢‡∏≤‡∏™‡∏ô‡πå\nüìç ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏°‡∏´‡∏≤‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á - ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°\nüìç ‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡∏±‡∏î‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£ - ‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏ç‡πà‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡πÇ‡∏•‡∏Å\n\n‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏õ‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö?',
  '3 ‡∏ß‡∏±‡∏ô': '‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÄ‡∏•‡∏¢! ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 3 ‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û ‡∏ú‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á:\n\nüóìÔ∏è **‡∏ß‡∏±‡∏ô 1**: ‡∏ß‡∏±‡∏î‡πÇ‡∏û‡∏ò‡∏¥‡πå ‚Üí ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏°‡∏´‡∏≤‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á ‚Üí ‡∏ß‡∏±‡∏î‡∏≠‡∏£‡∏∏‡∏ì\nüóìÔ∏è **‡∏ß‡∏±‡∏ô 2**: ‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡∏±‡∏î‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£ ‚Üí MBK Center ‚Üí ‡∏™‡∏¢‡∏≤‡∏°‡∏û‡∏≤‡∏£‡∏≤‡∏Å‡∏≠‡∏ô\nüóìÔ∏è **‡∏ß‡∏±‡∏ô 3**: ‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡πâ‡∏≥ ‚Üí ‡∏ß‡∏±‡∏î‡∏û‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß ‚Üí ‡∏ñ‡∏ô‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏≤‡∏£\n\n‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏≠‡∏ö‡πÅ‡∏ú‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö? ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á?',
  '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å': '‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß! üéâ\n\n‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ú‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡∏î‡∏π‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏ú‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô ‡∏à‡∏∞‡πÑ‡∏î‡πâ:\n‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ú‡∏ô‡πÑ‡∏ß‡πâ‡∏î‡∏π‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ\n‚úÖ ‡πÅ‡∏ä‡∏£‡πå‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô/‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß\n‚úÖ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô PDF\n\n[‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö] [‡∏Ç‡πâ‡∏≤‡∏° - ‡∏î‡∏π‡πÅ‡∏ú‡∏ô‡∏ï‡πà‡∏≠]',
  '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà': '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡∏°‡∏≤‡∏Å! ‡∏ú‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏õ:\n\nüìç ‡∏î‡∏≠‡∏¢‡∏™‡∏∏‡πÄ‡∏ó‡∏û - ‡∏ß‡∏±‡∏î‡∏ö‡∏ô‡∏î‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°\nüìç ‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô - ‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ç‡∏≤‡∏¢‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢\nüìç ‡∏ß‡∏±‡∏î‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏°‡∏±‡πà‡∏ô - ‡∏ß‡∏±‡∏î‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏Å‡πà‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á\n\n‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏õ‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö?',
  '‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô': '‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°! ‡∏ú‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏õ:\n\nüìç ‡∏ï‡∏•‡∏≤‡∏î‡∏™‡∏î‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô - ‡∏ï‡∏•‡∏≤‡∏î‡∏™‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô\nüìç ‡∏ä‡∏≤‡∏¢‡∏´‡∏≤‡∏î‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô - ‡∏´‡∏≤‡∏î‡∏ó‡∏£‡∏≤‡∏¢‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°\nüìç ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á‡πÑ‡∏Å‡∏•‡∏Å‡∏±‡∏á‡∏ß‡∏• - ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏Å‡πà\nüìç ‡∏≠‡∏∏‡∏ó‡∏¢‡∏≤‡∏ô‡∏£‡∏≤‡∏ä‡∏†‡∏±‡∏Å‡∏î‡∏¥‡πå - ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô\nüìç ‡πÄ‡∏Ç‡∏≤‡∏ï‡∏∞‡πÄ‡∏Å‡∏µ‡∏¢‡∏ö - ‡∏à‡∏∏‡∏î‡∏ä‡∏°‡∏ß‡∏¥‡∏ß‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°\n\n‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏õ‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö?',
  '‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô': '‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÄ‡∏•‡∏¢! ‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏°‡∏≤‡∏Å‡∏°‡∏≤‡∏¢ ‡∏ú‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏õ:\n\nüìç ‡∏ï‡∏•‡∏≤‡∏î‡∏™‡∏î‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô - ‡∏ï‡∏•‡∏≤‡∏î‡∏™‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô\nüìç ‡∏ä‡∏≤‡∏¢‡∏´‡∏≤‡∏î‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô - ‡∏´‡∏≤‡∏î‡∏ó‡∏£‡∏≤‡∏¢‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°\nüìç ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á‡πÑ‡∏Å‡∏•‡∏Å‡∏±‡∏á‡∏ß‡∏• - ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏Å‡πà\nüìç ‡∏≠‡∏∏‡∏ó‡∏¢‡∏≤‡∏ô‡∏£‡∏≤‡∏ä‡∏†‡∏±‡∏Å‡∏î‡∏¥‡πå - ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô\nüìç ‡πÄ‡∏Ç‡∏≤‡∏ï‡∏∞‡πÄ‡∏Å‡∏µ‡∏¢‡∏ö - ‡∏à‡∏∏‡∏î‡∏ä‡∏°‡∏ß‡∏¥‡∏ß‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°\n\n‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏õ‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö?',
  '2 ‡∏ß‡∏±‡∏ô': '‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÄ‡∏•‡∏¢! ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 2 ‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô ‡∏ú‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á:\n\nüóìÔ∏è **‡∏ß‡∏±‡∏ô 1**: ‡∏ï‡∏•‡∏≤‡∏î‡∏™‡∏î‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô ‚Üí ‡∏ä‡∏≤‡∏¢‡∏´‡∏≤‡∏î‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô ‚Üí ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á‡πÑ‡∏Å‡∏•‡∏Å‡∏±‡∏á‡∏ß‡∏•\nüóìÔ∏è **‡∏ß‡∏±‡∏ô 2**: ‡∏≠‡∏∏‡∏ó‡∏¢‡∏≤‡∏ô‡∏£‡∏≤‡∏ä‡∏†‡∏±‡∏Å‡∏î‡∏¥‡πå ‚Üí ‡πÄ‡∏Ç‡∏≤‡∏ï‡∏∞‡πÄ‡∏Å‡∏µ‡∏¢‡∏ö ‚Üí ‡∏ï‡∏•‡∏≤‡∏î‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô‡πÑ‡∏ô‡∏ó‡πå‡∏°‡∏≤‡∏£‡πå‡πÄ‡∏Å‡πá‡∏ï\n\n‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏≠‡∏ö‡πÅ‡∏ú‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö? ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á?',
  '‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô 2 ‡∏ß‡∏±‡∏ô': '‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÄ‡∏•‡∏¢! ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 2 ‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô ‡∏ú‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á:\n\nüóìÔ∏è **‡∏ß‡∏±‡∏ô 1**: ‡∏ï‡∏•‡∏≤‡∏î‡∏™‡∏î‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô ‚Üí ‡∏ä‡∏≤‡∏¢‡∏´‡∏≤‡∏î‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô ‚Üí ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á‡πÑ‡∏Å‡∏•‡∏Å‡∏±‡∏á‡∏ß‡∏•\nüóìÔ∏è **‡∏ß‡∏±‡∏ô 2**: ‡∏≠‡∏∏‡∏ó‡∏¢‡∏≤‡∏ô‡∏£‡∏≤‡∏ä‡∏†‡∏±‡∏Å‡∏î‡∏¥‡πå ‚Üí ‡πÄ‡∏Ç‡∏≤‡∏ï‡∏∞‡πÄ‡∏Å‡∏µ‡∏¢‡∏ö ‚Üí ‡∏ï‡∏•‡∏≤‡∏î‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô‡πÑ‡∏ô‡∏ó‡πå‡∏°‡∏≤‡∏£‡πå‡πÄ‡∏Å‡πá‡∏ï\n\n‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏≠‡∏ö‡πÅ‡∏ú‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö? ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á?',
  '‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô 2 ‡∏ß‡∏±‡∏ô': '‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÄ‡∏•‡∏¢! ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 2 ‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô ‡∏ú‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á:\n\nüóìÔ∏è **‡∏ß‡∏±‡∏ô 1**: ‡∏ï‡∏•‡∏≤‡∏î‡∏™‡∏î‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô ‚Üí ‡∏ä‡∏≤‡∏¢‡∏´‡∏≤‡∏î‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô ‚Üí ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á‡πÑ‡∏Å‡∏•‡∏Å‡∏±‡∏á‡∏ß‡∏•\nüóìÔ∏è **‡∏ß‡∏±‡∏ô 2**: ‡∏≠‡∏∏‡∏ó‡∏¢‡∏≤‡∏ô‡∏£‡∏≤‡∏ä‡∏†‡∏±‡∏Å‡∏î‡∏¥‡πå ‚Üí ‡πÄ‡∏Ç‡∏≤‡∏ï‡∏∞‡πÄ‡∏Å‡∏µ‡∏¢‡∏ö ‚Üí ‡∏ï‡∏•‡∏≤‡∏î‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô‡πÑ‡∏ô‡∏ó‡πå‡∏°‡∏≤‡∏£‡πå‡πÄ‡∏Å‡πá‡∏ï\n\n‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏≠‡∏ö‡πÅ‡∏ú‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö? ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á?',
  '‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï': '‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Å‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÉ‡∏ô‡∏†‡∏≤‡∏Ñ‡πÉ‡∏ï‡πâ! ‡∏ú‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏õ:\n\nüìç ‡∏´‡∏≤‡∏î‡∏õ‡πà‡∏≤‡∏ï‡∏≠‡∏á - ‡∏´‡∏≤‡∏î‡∏ó‡∏£‡∏≤‡∏¢‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°\nüìç ‡πÄ‡∏Å‡∏≤‡∏∞‡∏û‡∏µ‡∏û‡∏µ - ‡πÄ‡∏Å‡∏≤‡∏∞‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°\nüìç ‡∏ß‡∏±‡∏î‡∏â‡∏•‡∏≠‡∏á - ‡∏ß‡∏±‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏ô‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï\nüìç ‡∏û‡∏£‡∏∞‡πÉ‡∏´‡∏ç‡πà - ‡∏û‡∏£‡∏∞‡∏û‡∏∏‡∏ó‡∏ò‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà\nüìç ‡∏´‡πâ‡∏≤‡∏á‡πÄ‡∏ã‡πá‡∏ô‡∏ó‡∏£‡∏±‡∏•‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï - ‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á\n\n‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏õ‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö?',
  '‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï': '‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÄ‡∏•‡∏¢! ‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏°‡∏≤‡∏Å‡∏°‡∏≤‡∏¢ ‡∏ú‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏õ:\n\nüìç ‡∏´‡∏≤‡∏î‡∏õ‡πà‡∏≤‡∏ï‡∏≠‡∏á - ‡∏´‡∏≤‡∏î‡∏ó‡∏£‡∏≤‡∏¢‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°\nüìç ‡πÄ‡∏Å‡∏≤‡∏∞‡∏û‡∏µ‡∏û‡∏µ - ‡πÄ‡∏Å‡∏≤‡∏∞‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°\nüìç ‡∏ß‡∏±‡∏î‡∏â‡∏•‡∏≠‡∏á - ‡∏ß‡∏±‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏ô‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï\nüìç ‡∏û‡∏£‡∏∞‡πÉ‡∏´‡∏ç‡πà - ‡∏û‡∏£‡∏∞‡∏û‡∏∏‡∏ó‡∏ò‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà\nüìç ‡∏´‡πâ‡∏≤‡∏á‡πÄ‡∏ã‡πá‡∏ô‡∏ó‡∏£‡∏±‡∏•‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï - ‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á\n\n‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏õ‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö?',
  '‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï 3 ‡∏ß‡∏±‡∏ô': '‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÄ‡∏•‡∏¢! ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 3 ‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï ‡∏ú‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á:\n\nüóìÔ∏è **‡∏ß‡∏±‡∏ô 1**: ‡∏´‡∏≤‡∏î‡∏õ‡πà‡∏≤‡∏ï‡∏≠‡∏á ‚Üí ‡∏´‡∏≤‡∏î‡∏Å‡∏∞‡∏ï‡∏∞ ‚Üí ‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏£‡∏¥‡∏°‡∏ó‡∏∞‡πÄ‡∏•\nüóìÔ∏è **‡∏ß‡∏±‡∏ô 2**: ‡πÄ‡∏Å‡∏≤‡∏∞‡∏û‡∏µ‡∏û‡∏µ ‚Üí ‡πÄ‡∏Å‡∏≤‡∏∞‡πÑ‡∏Ç‡πà ‚Üí ‡∏î‡∏≥‡∏ô‡πâ‡∏≥‡∏î‡∏π‡∏õ‡∏∞‡∏Å‡∏≤‡∏£‡∏±‡∏á\nüóìÔ∏è **‡∏ß‡∏±‡∏ô 3**: ‡∏ß‡∏±‡∏î‡∏â‡∏•‡∏≠‡∏á ‚Üí ‡∏û‡∏£‡∏∞‡πÉ‡∏´‡∏ç‡πà ‚Üí ‡∏´‡πâ‡∏≤‡∏á‡πÄ‡∏ã‡πá‡∏ô‡∏ó‡∏£‡∏±‡∏•‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï\n\n‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏≠‡∏ö‡πÅ‡∏ú‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö? ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á?',
  '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà': '‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏ú‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ\n\n‡∏ö‡∏≠‡∏Å‡∏ú‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£',
  '‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÅ‡∏ú‡∏ô': '‡∏ú‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö!\n\n‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ:\n‚Ä¢ ‡∏•‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£\n‚Ä¢ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà\n‚Ä¢ ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà\n‚Ä¢ ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢\n\n‡∏ö‡∏≠‡∏Å‡∏ú‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á',
  '‡∏•‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà': '‡∏ú‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ä‡πà‡∏ß‡∏¢‡∏•‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö\n\n‡∏ö‡∏≠‡∏Å‡∏ú‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á "‡∏•‡∏ö [‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà]"\n\n‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:\n‚Ä¢ "‡∏•‡∏ö ‡∏ß‡∏±‡∏î‡πÇ‡∏û‡∏ò‡∏¥‡πå"\n‚Ä¢ "‡∏•‡∏ö ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏°‡∏´‡∏≤‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á"\n‚Ä¢ "‡∏•‡∏ö ‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡∏±‡∏î‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£"\n\n‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö (üóëÔ∏è) ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£',
  '‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà': '‡∏ú‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö!\n\n‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ:\n‚Ä¢ ‡∏•‡∏≤‡∏Å‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏±‡∏ô\n‚Ä¢ ‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏ß‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô\n‚Ä¢ ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å\n\n‡∏ö‡∏≠‡∏Å‡∏ú‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£',
  '‡∏•‡∏ö ‡∏ß‡∏±‡∏î‡πÇ‡∏û‡∏ò‡∏¥‡πå': '‡∏•‡∏ö ‡∏ß‡∏±‡∏î‡πÇ‡∏û‡∏ò‡∏¥‡πå ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö!',
  '‡∏•‡∏ö ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏°‡∏´‡∏≤‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á': '‡∏•‡∏ö ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏°‡∏´‡∏≤‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö!',
  '‡∏•‡∏ö ‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡∏±‡∏î‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£': '‡∏•‡∏ö ‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡∏±‡∏î‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö!'
};

export const hybridAiService = {
  // Multi-provider AI responses
  async sendMessage(message: string, context?: any, language: string = 'th'): Promise<AIResponse> {
    // Check if we should use mock or real AI
    const useMock = useMockAi();

    if (useMock) {
      console.log('ü§ñ Using Mock AI Service for development');
      return await this.mockSendMessage(message, context, language);
    }

    try {
      console.log('üöÄ Using Real AI Service (OpenAI + Gemini Fallback)');
      
      // Call Edge Function using supabase-js with JWT authentication
      const response = await supabase.functions.invoke('ai-chat', {
        body: {
          message,
          conversationHistory: context?.conversationHistory || [],
          provider: 'openai',
          trip_id: context?.tripId, // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å tripId ‡πÄ‡∏õ‡πá‡∏ô trip_id
          temperature: 0.7,
          language: language // Pass language parameter
        }
      });

      if (response.error) {
        throw new Error(response.error.message);
      }

      return {
        success: true,
        response: response.data.message, // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å .text ‡πÄ‡∏õ‡πá‡∏ô .message
        suggestLogin: response.data.suggest_login || false,
        loginReason: response.data.login_reason || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á'
      };
    } catch (error) {
      console.warn('Real AI failed, falling back to mock:', error);
      return await this.mockSendMessage(message, context, language);
    }
  },

  // Mock AI responses
  async mockSendMessage(message: string, context?: any, language: string = 'th'): Promise<AIResponse> {
    // Simulate API delay
    await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));

    // Check for provinces in the message
    const foundProvinces = findProvincesInText(message);
    console.log('üèõÔ∏è Found provinces in message:', foundProvinces);

    // Find matching response
    let response = '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏ú‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏£‡∏±‡∏ö';
    let suggestLogin = false;

    for (const [keyword, reply] of Object.entries(mockResponses)) {
      if (message.includes(keyword)) {
        response = reply;
        suggestLogin = message.includes('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å') || message.includes('‡πÅ‡∏ä‡∏£‡πå') || message.includes('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å');
        break;
      }
    }

    // If no specific match, check for provinces
    if (response === '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏ú‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏£‡∏±‡∏ö' && foundProvinces.length > 0) {
      const province = foundProvinces[0];
      if (province.name === '‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï') {
        response = `‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÄ‡∏•‡∏¢! ‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Å‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÉ‡∏ô‡∏†‡∏≤‡∏Ñ‡πÉ‡∏ï‡πâ!\n\n‡∏ú‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏õ:\n\nüìç ‡∏´‡∏≤‡∏î‡∏õ‡πà‡∏≤‡∏ï‡∏≠‡∏á - ‡∏´‡∏≤‡∏î‡∏ó‡∏£‡∏≤‡∏¢‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°\nüìç ‡πÄ‡∏Å‡∏≤‡∏∞‡∏û‡∏µ‡∏û‡∏µ - ‡πÄ‡∏Å‡∏≤‡∏∞‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°\nüìç ‡∏ß‡∏±‡∏î‡∏â‡∏•‡∏≠‡∏á - ‡∏ß‡∏±‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏ô‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï\nüìç ‡∏û‡∏£‡∏∞‡πÉ‡∏´‡∏ç‡πà - ‡∏û‡∏£‡∏∞‡∏û‡∏∏‡∏ó‡∏ò‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà\nüìç ‡∏´‡πâ‡∏≤‡∏á‡πÄ‡∏ã‡πá‡∏ô‡∏ó‡∏£‡∏±‡∏•‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï - ‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á\n\n‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏õ‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö?`;
      } else {
        response = `‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÄ‡∏•‡∏¢! ${province.name} ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°‡πÉ‡∏ô${province.region}!\n\n‡∏ú‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏õ:\n\nüìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏´‡∏•‡∏±‡∏Å\nüìç ‡∏ß‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç\nüìç ‡∏ï‡∏•‡∏≤‡∏î‡πÅ‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£\n\n‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏õ‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö?`;
      }
    }

    // If still no match, provide generic response
    if (response === '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏ú‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏£‡∏±‡∏ö') {
      response = '‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏°‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏ú‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ\n\n‡∏•‡∏≠‡∏á‡∏ö‡∏≠‡∏Å‡∏ú‡∏°‡∏ß‡πà‡∏≤:\n‚Ä¢ ‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô?\n‚Ä¢ ‡πÑ‡∏õ‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô?\n‚Ä¢ ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?\n‚Ä¢ ‡πÑ‡∏õ‡∏Å‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£? (‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß, ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô, ‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å)\n\n‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á:\n‚Ä¢ "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà"\n‚Ä¢ "‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÅ‡∏ú‡∏ô"\n‚Ä¢ "‡∏•‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà"\n‚Ä¢ "‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà"';
    }

    return {
      success: true,
      response,
      suggestLogin,
      loginReason: suggestLogin ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á' : null
    };
  },

  // Chat history
  async getChatHistory(tripId?: string): Promise<ChatMessage[]> {
    try {
      const { data, error } = await supabase
        .from('chat_messages')
        .select('*')
        .eq('trip_id', tripId || null)
        .order('created_at', { ascending: true });

      if (error) throw error;
      return (data || []).map(msg => ({
        ...msg,
        role: msg.role as 'user' | 'assistant' | 'system'
      }));
    } catch (error) {
      console.error('Get chat history error:', error);
      return [];
    }
  },

  // Save message
  async saveMessage(message: ChatMessage, tripId?: string): Promise<ChatMessage> {
    try {
      // Validate tripId is a valid UUID format
      const validTripId = tripId && isValidUUID(tripId) ? tripId : null;

      // Clean message object to remove any invalid UUIDs
      const cleanMessage: any = {
        trip_id: validTripId, // Can be NULL now
        role: message.role,
        content: message.content,
        content_en: message.content_en,
        language: message.language || 'th',
        created_at: message.created_at || new Date().toISOString()
      };

      // Add user_id or guest_id based on authentication status
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (user?.id) {
          cleanMessage.user_id = user.id;
          cleanMessage.guest_id = null;
        } else {
          // Guest user
          cleanMessage.user_id = null;
          cleanMessage.guest_id = getGuestId();
        }
      } catch (error) {
        // User not authenticated, use guest mode
        console.log('User not authenticated, saving as guest message');
        cleanMessage.user_id = null;
        cleanMessage.guest_id = getGuestId();
      }

      console.log('üíæ Saving message to database:', cleanMessage);

      const { data, error } = await supabase
        .from('chat_messages')
        .insert(cleanMessage)
        .select()
        .single();

      if (error) {
        console.error('‚ùå Database save error:', error);
        throw error;
      }
      
      console.log('‚úÖ Message saved successfully:', data);
      return {
        ...data,
        role: data.role as 'user' | 'assistant' | 'system'
      };
    } catch (error) {
      console.error('‚ùå Save message error:', error);
      return message; // Return original message if save fails
    }
  },

  // Get recommendations
  async getRecommendations(userId: string, tripId?: string): Promise<any[]> {
    try {
      // Use destinations table instead of non-existent ai_recommendations
      const { data, error } = await supabase
        .from('destinations')
        .select('*')
        .eq('trip_id', tripId || null)
        .order('order_index', { ascending: true });

      if (error) throw error;
      return data || [];
    } catch (error) {
      console.error('Get recommendations error:', error);
      return [];
    }
  }
};
